# 1. 启动文件详解

- [1. 启动文件详解](#1-启动文件详解)
  - [1.1. 栈 Stack](#11-栈-stack)
  - [1.2. 堆 Heap](#12-堆-heap)
  - [1.3. 向量表](#13-向量表)
  - [1.4. 复位程序](#14-复位程序)
  - [1.5. 中断服务程序](#15-中断服务程序)
  - [1.6. 用户堆栈初始化](#16-用户堆栈初始化)
  - [1.7. 案例](#17-案例)

## 1.1. 栈 Stack
> 栈的作用是用于局部变量，函数调用，函数形参等的开销，栈的大小不能超过内部 SRAM 的大小。如果编写的程序比较大，定义的局部变量很多，那么就需要修改栈的大小。如果某一天，你写的程序出现了莫名奇怪的错误，并进入了硬 fault 的时候，这时你就要考虑下是不是栈不够大，溢出了。

## 1.2. 堆 Heap
> 堆主要用来动态内存的分配，像 malloc() 函数申请的内存就在堆上面。

## 1.3. 向量表
> 当内核响应了一个发生的异常后，对应的异常服务例程 (ESR) 就会执行。为了决定 ESR 的入口地址，内核使用了“向量表查表机制”。这里使用一张向量表。向量表其实是一个 WORD（32 位整数）数组，每个下标对应一种异常，该下标元素的值则是该 ESR 的入口地址。向量表在地址空间中的位置是可以设置的，通过 NVIC 中的一个重定位寄存器来指出向量表的地址。在复位后，该寄存器的值为 0。因此，在地址 0 （即 FLASH 地址 0）处必须包含一张向量表，用于初始时的异常分配。要注意的是这里有个另类：0 号类型并不是什么入口地址，而是给出了复位后 MSP 的初值。

## 1.4. 复位程序
> 复位子程序是系统上电后第一个执行的程序，调用 SystemInit 函数初始化系统时钟，然后调用 C库函数 _main，最终调用 main 函数去到 C 的世界。
>
> SystemInit() 是一个标准的库函数，在 system_stm32f10x.c 这个库文件总定义。主要作用是配置系统时钟，这里调用这个函数之后，单片机的系统时钟配被配置为 72M。
>
> __main 是一个标准的 C 库函数，主要作用是初始化用户堆栈，并在函数的最后调用 main 函数去到 C 的世界。这就是为什么我们写的程序都有一个 main 函数的原因。

## 1.5. 中断服务程序
> 在启动文件里面已经帮我们写好所有中断的中断服务函数，跟我们平时写的中断服务函数不一样的就是这些函数都是空的，真正的中断复服务程序需要我们在外部的 C 文件里面重新实现，这里只是提前占了一个位置而已。
>
> 如果我们在使用某个外设的时候，开启了某个中断，但是又忘记编写配套的中断服务程序或者函数名写错，那当中断来临的时，程序就会跳转到启动文件预先写好的空的中断服务程序中，并且在这个空函数中无线循环，即程序就死在这里。

## 1.6. 用户堆栈初始化
> 首先判断是否定义了 __MICROLIB ，如果定义了这个宏则赋予标号 __initial_sp（栈顶地址）、__heap_base（堆起始地址）、__heap_limit（堆结束地址）全局属性，可供外部文件调用。有关这个宏我们在 KEIL 里面配置，然后堆栈的初始化就由 C 库函数 _main 来完成。

## 1.7. 案例
[startup_stm32f10x_hd.s](startup_stm32f10x_hd.s)